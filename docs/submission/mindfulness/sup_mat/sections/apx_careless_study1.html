<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>apx_careless_study1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="apx_careless_study1_files/libs/clipboard/clipboard.min.js"></script>
<script src="apx_careless_study1_files/libs/quarto-html/quarto.js"></script>
<script src="apx_careless_study1_files/libs/quarto-html/popper.min.js"></script>
<script src="apx_careless_study1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="apx_careless_study1_files/libs/quarto-html/anchor.min.js"></script>
<link href="apx_careless_study1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="apx_careless_study1_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="apx_careless_study1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="apx_careless_study1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="apx_careless_study1_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<p>To ensure data quality, we implemented a procedure for identifying and excluding participants exhibiting patterns of inattentive or careless responding.</p>
<section id="phase-1" class="level3">
<h3 class="anchored" data-anchor-id="phase-1">Phase 1</h3>
<p>In the initial phase, we administered three questionnaires to assess the sample characteristics: the Difficulties in Emotion Regulation Scale (DERS), the Self-Compassion Scale (SCS), and the Depression, Anxiety, and Stress Scale - 21 Items (DASS-21). The responses were evaluated using the <strong>careless</strong> R package, which provides multiple indices for assessing response quality. Specifically, we computed the following metrics: the Longstring Index, Intra-Individual Response Variability (IRV), the Even-Odd Inconsistency Index, and Mahalanobis Distance.</p>
<section id="longstring-index" class="level4">
<h4 class="anchored" data-anchor-id="longstring-index">Longstring Index</h4>
<p>The Longstring Index quantifies the longest sequence of consecutive identical responses given by a participant during a single measurement occasion. Elevated Longstring Index values may indicate “straightlining,” a response pattern typically associated with inattentive or careless behavior. Participants with exceptionally high Longstring Index values may exhibit a greater propensity for careless responding.</p>
</section>
<section id="intra-individual-response-variability" class="level4">
<h4 class="anchored" data-anchor-id="intra-individual-response-variability">Intra-Individual Response Variability</h4>
<p>Intra-Individual Response Variability (IRV) is calculated as the standard deviation of responses across a series of consecutive items for an individual. A lower IRV may indicate reduced engagement or a stronger tendency toward careless responding.</p>
</section>
<section id="even-odd-inconsistency-index" class="level4">
<h4 class="anchored" data-anchor-id="even-odd-inconsistency-index">Even-Odd Inconsistency Index</h4>
<p>The Even-Odd Inconsistency Index evaluates response inconsistency by splitting a unidimensional scale into two halves—based on even- and odd-numbered items—and analyzing the relationship between these subsets. The process involves the following steps:</p>
<ol type="1">
<li><strong>Divide the scale</strong>: Items are split into two subsets, with even-numbered items forming one subset and odd-numbered items forming the other.<br>
</li>
<li><strong>Calculate subscale scores</strong>: The mean response for each subset is computed, producing two scores—one for the even-numbered items and one for the odd-numbered items.<br>
</li>
<li><strong>Determine within-person correlation</strong>: A correlation is calculated between the two subscale scores for each participant, with the even scores treated as variable <span class="math inline">\(x\)</span> and the odd scores as variable <span class="math inline">\(y\)</span>, yielding a correlation coefficient <span class="math inline">\(r(x, y)\)</span>.<br>
</li>
<li><strong>Adjust for scale length</strong>: The correlation is corrected for the reduced scale length using the Spearman–Brown prophecy formula.<br>
</li>
<li><strong>Derive the inconsistency score</strong>: The final inconsistency score is calculated as <span class="math inline">\(0 - r(x, y)\)</span>, where higher values reflect greater response inconsistency and indicate a higher likelihood of careless responding.</li>
</ol>
<p>Higher scores on the Even-Odd Inconsistency Index suggest greater response inconsistency, indicating a stronger propensity for careless responding.</p>
</section>
<section id="mahalanobis-distance" class="level4">
<h4 class="anchored" data-anchor-id="mahalanobis-distance">Mahalanobis Distance</h4>
<p>Mahalanobis Distance (<span class="math inline">\(D^2\)</span>) is a multivariate metric commonly used to identify outliers, including response patterns that may indicate careless or inattentive behavior. It quantifies the distance of an individual’s response set from the overall distribution of responses in the dataset, considering correlations between variables. Higher <span class="math inline">\(D^2\)</span> values indicate that a participant’s responses deviate significantly from the typical response pattern, potentially signaling careless responding. Conversely, lower <span class="math inline">\(D^2\)</span> values suggest responses that align more closely with the average, indicating more consistent and engaged behavior.</p>
</section>
<section id="threshold-for-identifying-careless-responders" class="level4">
<h4 class="anchored" data-anchor-id="threshold-for-identifying-careless-responders">Threshold for Identifying Careless Responders</h4>
<p>To identify participants exhibiting careless responding, we established a threshold based on the 95th percentile of the distribution of mean scores for each response quality index. For each index (Longstring Index, IRV, Even-Odd Inconsistency Index, and Mahalanobis Distance), participants with scores exceeding this threshold were flagged as potential careless responders.</p>
<p>Participants were classified as careless responders if their scores exceeded the 95th percentile on more than two indices. This multi-index criterion ensured a robust and conservative approach to identifying inattentive behavior while minimizing false positives.</p>
<p>Using this method, we identified 11 participants who met the criteria for careless responding. These individuals were excluded from subsequent Ecological Momentary Assessment (EMA) data collection to maintain data quality.</p>
</section>
</section>
<section id="phase-2-ensuring-response-quality-in-ema-data" class="level3">
<h3 class="anchored" data-anchor-id="phase-2-ensuring-response-quality-in-ema-data">Phase 2: Ensuring Response Quality in EMA Data</h3>
<p>For the Ecological Momentary Assessment (EMA) phase, we implemented additional checks to evaluate response quality at the individual level across repeated administrations of the 8-item State Self-Compassion Scale. On each administration occasion, we calculated the same four indices used in the initial phase—Longstring Index, IRV, Even-Odd Inconsistency Index, and Mahalanobis Distance—and computed the average score for each index per participant.</p>
<p>In this phase, the computation of the Even-Odd Inconsistency Index followed the same procedure as described above, with Compassionate Self (CS) items assigned to the odd subset and Uncompassionate Self (UCS) items assigned to the even subset.</p>
<p>Participants were flagged for potential careless responding if their average scores exceeded the 95th percentile of the mean distribution on more than two indices.</p>
<section id="results" class="level4">
<h4 class="anchored" data-anchor-id="results">Results</h4>
<ul>
<li><strong>Longstring Index:</strong> Participants flagged for exceeding the threshold:</li>
</ul>
<pre><code> [1] "2YT2Lxkzu7" "50qYMJwD8N" "63IObkfSHx" "F2YHb3ISFZ" "KUEiypvJoM" "Otxt5fRSy6"
 [7] "QqSg1RbPeN" "Rp8mO6snWl" "bw8oq00xYo" "e6w3iqr2ZH" "gus0dKCjgM" "jU4Wj6air0"
[13] "ktkG5ChYNP" "mmzVj55KT0" "mz8M9nkmvM" "nv4XDDNH1C" "r8NsT3h96u"</code></pre>
<ul>
<li><strong>Intra-Individual Response Variability:</strong> Participants flagged:</li>
</ul>
<pre><code> [1] "0b9tNpJcsY" "459SDg5smW" "4UcQ3PhJCd" "BsYcfQHyCu" "EBWRPnxXbk" "JlltLjAV0T"
 [7] "LJQt163ZIb" "O6liWwvs8n" "RYm4VOpYkV" "U7A10m2XXJ" "Yh6faGWqG6" "ZlhUMB2vlh"
[13] "e7enohWIP5" "grm8v68tBN" "iXpIlDkx7e" "op5JniIlG9" "r7e78LOfln"</code></pre>
<ul>
<li><strong>Even-Odd Inconsistency Index:</strong> Participants flagged:</li>
</ul>
<pre><code> [1] "7988HNpVDD" "C2nVCp7cVt" "EBWRPnxXbk" "MIZ0dfOj4O" "O6liWwvs8n" "RcArsbnLNm"
 [7] "Siq43IG7Ko" "TMjk1oo69k" "Ug9hqvsYWP" "Vls71ygrgd" "bOqhhxnjfi" "eOkjdHrlBB"
[13] "jqsXLoMB4N" "op5JniIlG9" "qJHg8m0cpI" "wrTTvWX1Fw" "xo3CmkgrhG"</code></pre>
<ul>
<li><strong>Mahalanobis Distance:</strong> Participants flagged:</li>
</ul>
<pre><code> [1] "54TfRmBgpp" "DS6HZoffxR" "DuhnbfPWeP" "EPBkmQUANo" "GeqW5Iel65" "H0FrFMiGGp"
 [7] "Hm0ux84t6e" "JEhiyebtOd" "KSYbgBcFLW" "L6gQoZ3mnP" "Nr9EqBjcX3" "O6liWwvs8n"
[13] "UUEs17q9dj" "adjOVDgWzY" "kn4lgTHVxG" "m9AeRnwOnC" "op5JniIlG9"</code></pre>
</section>
<section id="integration-of-metrics-to-determine-careless-responding" class="level4">
<h4 class="anchored" data-anchor-id="integration-of-metrics-to-determine-careless-responding">Integration of Metrics to Determine Careless Responding</h4>
<p>The following R script integrates the four indices (Mahalanobis Distance, Longstring Index, IRV, and Even-Odd Inconsistency Index) to identify participants flagged for careless responding. It calculates the number of participants whose scores exceeded the threshold (95th percentile) in various combinations of indices:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vectors <span class="ot">&lt;-</span> <span class="fu">list</span>(mahad_bad, longstring_bad, irv_bad, even_odd_bad)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to find shared elements across combinations</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>shared_counts <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="sc">~</span> {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  combos <span class="ot">&lt;-</span> <span class="fu">combn</span>(vectors, .x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  shared <span class="ot">&lt;-</span> <span class="fu">map</span>(combos, <span class="sc">~</span> <span class="fu">Reduce</span>(intersect, .x)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(shared)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">set_names</span>(<span class="fu">paste0</span>(<span class="st">"shared_by_"</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the results</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>shared_counts</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># $shared_by_2</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 3</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># $shared_by_3</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># $shared_by_4</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="final-assessment" class="level4">
<h4 class="anchored" data-anchor-id="final-assessment">Final Assessment</h4>
<p>This analysis revealed that no participants exceeded the threshold in more than two indices during the EMA phase. As a result, all participants who complied with the study’s response frequency requirements were included in the final statistical analyses.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>